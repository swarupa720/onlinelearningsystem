{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ course.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'courses:course_list' %}">LearningSystem</a>
        <div class="ms-auto text-white d-flex align-items-center">
            Welcome, {{ request.user.username }}

            <!-- POST logout form -->
            <form method="POST" action="{% url 'logout' %}" class="ms-3">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-light">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="card shadow p-4 mb-4">
        <h1 class="mb-3 text-primary">{{ course.title }}</h1>

        <div class="row mb-3">
            <div class="col">
                <span class="badge bg-secondary me-2">Total Lessons: {{ total }}</span>
                <span class="badge bg-success me-2">Completed: {{ completed }}</span>
                <span class="badge bg-info text-dark">Progress: {{ progress_percent }}%</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress mb-4" style="height: 25px;">
            <div class="progress-bar progress-bar-striped bg-success" 
                 role="progressbar" 
                 style="width: {{ progress_percent }}%;" 
                 aria-valuenow="{{ progress_percent }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                {{ progress_percent }}%
            </div>
        </div>

        <!-- Enroll Button for Students -->
        {% if not is_enrolled and course.created_by != request.user %}
            <form method="POST" action="{% url 'courses:enroll-course' course.id %}" class="mb-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-lg">
                    üìö Enroll in this Course
                </button>
            </form>
        {% endif %}

        <!-- Download Certificate Button -->
        {% if request.user.is_authenticated and course_completed %}
            <a href="{% url 'courses:download_certificate' course.id %}" class="btn btn-success mb-4">
                üéì Download Certificate
            </a>
        {% endif %}

        <!-- Lesson List -->
        <h4 class="mb-3">Lessons</h4>
        {% if lessons %}
            <ul class="list-group">
                {% for lesson in lessons %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'courses:lesson-detail' lesson.id %}" class="text-decoration-none fw-semibold">
                                {{ lesson.title }}
                            </a>
                            {% if lesson.id|id_in_list:completed_ids %}
                                <span class="badge bg-success ms-2">‚úÖ Completed</span>
                            {% else %}
                                <span class="badge bg-warning text-dark ms-2">‚ùå Incomplete</span>
                            {% endif %}
                        </div>
                        <div>
                            {% if lesson.course.created_by == request.user %}
                                <a href="{% url 'courses:delete_lesson' lesson.id %}" 
                                   class="btn btn-sm btn-danger" 
                                   onclick="return confirm('Are you sure you want to delete this lesson?');">
                                    Delete Lesson
                                </a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="alert alert-info mt-3">
                No lessons found in this course yet.
            </div>
        {% endif %}

        <!-- Delete Course Button -->
        {% if course.created_by == request.user %}
            <div class="mt-4">
                <a href="{% url 'courses:delete_course' course.id %}" class="btn btn-danger"
                   onclick="return confirm('Are you sure you want to delete this entire course? This action cannot be undone!');">
                    Delete Entire Course
                </a>
            </div>
        {% endif %}
    </div>
</div>

</body>
</html>
