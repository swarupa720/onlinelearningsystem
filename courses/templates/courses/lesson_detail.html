{% load custom_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ lesson.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-container {
            margin-bottom: 20px;
        }
        .quiz-locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <h2 class="mb-4 text-primary">{{ lesson.title }}</h2>

    <!-- Progress Bar -->
    <div class="progress-container">
        <label class="form-label fw-bold">Course Progress: {{ progress_percent }}%</label>
        <div class="progress">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width: {{ progress_percent }}%;" aria-valuenow="{{ progress_percent }}"
                 aria-valuemin="0" aria-valuemax="100">
                {{ progress_percent }}%
            </div>
        </div>
    </div>

    <!-- Embedded YouTube Video -->
    <div class="ratio ratio-16x9 mb-4">
        <iframe
            id="lesson-video"
            src="{{ lesson.video_url|youtube_embed }}?enablejsapi=1"
            title="Lesson Video"
            allowfullscreen>
        </iframe>
    </div>

    <!-- Locked Quiz Button -->
    <div class="text-center">
        <button id="quiz-button" class="btn btn-secondary quiz-locked" disabled>
            üîí Quiz Locked ‚Äì Watch full video
        </button>
    </div>

    <!-- Next Lesson Button (if current lesson is completed) -->
    {% if next_lesson and lesson.id in completed_lesson_ids %}
        <div class="text-center mt-4">
            <a href="{% url 'courses:lesson-detail' next_lesson.id %}" class="btn btn-primary">
                ‚ñ∂Ô∏è Next Lesson: {{ next_lesson.title }}
            </a>
        </div>
    {% endif %}
</div>

<!-- YouTube API Logic -->
<script>
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    let player;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('lesson-video', {
            events: {
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerStateChange(event) {
        if (event.data === 0) {
            const button = document.getElementById("quiz-button");
            button.disabled = false;
            button.classList.remove('quiz-locked');
            button.classList.replace('btn-secondary', 'btn-success');
            button.innerText = "üìù Take Quiz";

            button.addEventListener('click', function () {
                window.location.href = "{% url 'courses:quiz' lesson.id %}";
            });
        }
    }
</script>

</body>
</html>
